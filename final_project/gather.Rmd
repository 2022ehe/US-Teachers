---
title: "Gathering Data"
author: "Emily He"
date: "10/16/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(readxl)
library(gganimate)
library(maps)
library(mapproj)
```

```{r rds}
saveRDS(ms, "ms_cert.RDS")
saveRDS(hs, "hs_cert.RDS")
saveRDS(public_age_join, "public_age.RDS")
saveRDS(private_age_join, "private_age.RDS")
saveRDS(age_plot, 'age.RDS')
saveRDS(public_degree_join, "public_degree.RDS")
saveRDS(private_degree_join, "private_degree.RDS")
saveRDS(public_years_join, "public_years.RDS")
saveRDS(private_years_join, "private_years.RDS")
saveRDS(state_degree, "state_degree.RDS")
saveRDS(state_years, "state_years.RDS")
```

```{r sass ms}

# Load in certification data from SASS
certification <- read_excel("sass_data/sass1112_18042404_t2n.xlsx", skip = 3,
                            col_types = c('text', 
                                          'numeric', 
                                          'skip',
                                          'numeric', 
                                          'skip', 
                                          'numeric', 
                                          'skip', 
                                          'numeric', 
                                          'skip', 
                                          'numeric', 
                                          'skip'),
                            col_names = c('level_subject', 
                                          'cert_total', 
                                          'cert_major', 
                                          'cert_only', 
                                          'major_only', 
                                          'neither'))

# Select middle school data
ms <- certification %>%
  slice(2:6) %>%
  select(-cert_total) %>%
  pivot_longer(cols = -level_subject, 
               names_to = 'qualification', 
               values_to = 'percentage') %>%
  drop_na() %>%
  filter(level_subject != 'General elementary education')

# Plot middle school data
ggplot(ms, aes(x = level_subject, y = percentage, fill = qualification)) + 
  geom_col(position = 'dodge') + 
  scale_fill_manual(name = 'Teacher Qualification',
                    labels = c('Certification and Related Major',
                               'Certification Only',
                               'Related Major Only',
                               'Neither Qualification'),
                    values = c("steelblue", "steelblue2", "steelblue3", "steelblue4")) + 
  theme_bw() +
  labs(title = 'Percentage of U.S. Middle School Students Taught By 
  Teachers with Various Qualifications in 2011-2012',
       subtitle = 'A majority of students are taught by science teachers without state 
  certifications or a related academic major.',
       x = 'Class Subject',
       y = 'Percentage of Students',
       caption = 'Source: U.S. Department of Education, National Center for Education Statistics')

```

```{r sass hs}
# Curate high school data
hs <- certification %>%
  slice(9:12) %>%
  select(-cert_total) %>%
  pivot_longer(cols = -level_subject, 
               names_to = 'qualification', 
               values_to = 'percentage') %>%
  drop_na() %>%
  filter(level_subject != 'General elementary education')

ggplot(hs, aes(x = level_subject, y = percentage, fill = qualification)) + 
  geom_col(position = 'dodge') + 
  scale_fill_brewer(name = 'Teacher Qualification', 
                    labels = c('Certification and Related Major',
                               'Certification Only',
                               'Related Major Only', 
                               'Neither Qualification'),
                    palette = 'Blues') + 
  theme_bw() +
  labs(title = 'Percentage of U.S. High School Students Taught By 
  Teachers with Various Qualifications in 2011-2012',
       subtitle = 'A majority of students are taught by science teachers without state 
  certifications or a related academic major.',
       x = 'Class Subject',
       y = 'Percentage of Students',
       caption = 'Source: U.S. Department of Education, National Center for Education Statistics')
```

```{r nces, warning = FALSE}
# warning = FALSE because converted symbol to numeric

tabn209_10 <- read_excel("nces_data/tabn209.10.xls", 
                         skip = 5,
    col_types = c("text", "numeric", "skip", 
        "numeric", "numeric", "skip", "numeric", "numeric", 
        "skip", "numeric", "numeric", "skip", "numeric", 
        "numeric", "skip", "numeric", "numeric", "skip", 
        "numeric", "numeric", "skip", "numeric", "numeric", 
        "skip", "numeric", "numeric", "skip", "numeric", 
        "numeric", "skip", "numeric", "numeric", "skip", 
        "numeric", "numeric", "skip", "numeric", "numeric", 
        "skip", "numeric", "numeric", "skip", "numeric"),
    col_names = c('teacher_char', '1987-88_n', '1987-88_n_se', 
                  '1990-91_n', '1990-91_n_se', '1999-2000_n', '1999-2000_n_se', 
                  '2003-04_n', '2003-04_n_se', '2007-08_n', '2007-08_n_se', 
                  '2011-12_n', '2011-12_n_se','2017-18_n','2017-18_n_se', 
                  '1987-88_p', '1987-88_p_se',
                  '1990-91_p', '1990-91_p_se', '1999-2000_p', '1999-2000_p_se', 
                  '2003-04_p', '2003-04_p_se', '2007-08_p', '2007-08_p_se', 
                  '2011-12_p', '2011-12_p_se','2017-18_p','2017-18_p_se'))

public <- tabn209_10 %>%
  slice(1:53)

private <- tabn209_10 %>%
  slice(54:86)
                  
```

```{r age_public}
# Percentage values for public schools across all years
public_age_p <- public %>%
  slice(15:19) %>%
  select(c('teacher_char', `1987-88_p`, `1990-91_p`, `1999-2000_p`, `2003-04_p`,
           `2007-08_p`, `2011-12_p`, `2017-18_p`)) %>%
  rename_with(~tolower(gsub("_p", "", .x))) %>%
  pivot_longer(cols = -teacher_char, names_to = 'year', values_to = 'percentage')

# Percentage standard error values for public schools across all years
public_age_p_se <- public %>%
  slice(15:19) %>%
  select(c('teacher_char', `1987-88_p_se`, `1990-91_p_se`, `1999-2000_p_se`, 
           `2003-04_p_se`,`2007-08_p_se`, `2011-12_p_se`, `2017-18_p_se`)) %>%
  rename_with(~tolower(gsub("_p_se", "", .x))) %>%
  pivot_longer(cols = -teacher_char, names_to = 'year', values_to = 'se')

# Merged tibble for percentage + standard errors
public_age_join <- left_join(public_age_p, 
                             public_age_p_se, 
                             by = c('year', 'teacher_char')) %>%
  mutate(max = percentage + se,
         min = percentage - se) %>%
  mutate(type = "Public")

public_age_join %>%
  filter(teacher_char == '40 to 49') %>%
  ggplot(aes(x = year, y = percentage)) +
  geom_point(size = 2) +
  geom_errorbar(aes(x = year, ymin = min, ymax = max),
                width=0.1, color = 'dodgerblue', alpha=0.9, size=1) +
  labs(title = 'Age Ranges of U.S. Teachers in Public Schools from 1987-2018',
       x = 'Year',
       y = 'Percentage of Teachers')

```

```{r age_private}
# Percentage values for public schools across all years
private_age_p <- private %>%
  slice(15:19) %>%
  select(c('teacher_char', `1987-88_p`, `1990-91_p`, `1999-2000_p`, `2003-04_p`,
           `2007-08_p`, `2011-12_p`, `2017-18_p`)) %>%
  rename_with(~tolower(gsub("_p", "", .x))) %>%
  pivot_longer(cols = -teacher_char, names_to = 'year', values_to = 'percentage')

# Percentage standard error values for public schools across all years
private_age_p_se <- private %>%
  slice(15:19) %>%
  select(c('teacher_char', `1987-88_p_se`, `1990-91_p_se`, `1999-2000_p_se`, 
           `2003-04_p_se`,`2007-08_p_se`, `2011-12_p_se`, `2017-18_p_se`)) %>%
  rename_with(~tolower(gsub("_p_se", "", .x))) %>%
  pivot_longer(cols = -teacher_char, names_to = 'year', values_to = 'se')

# Merged tibble for percentage + standard errors
private_age_join <- left_join(private_age_p, 
                             private_age_p_se, 
                             by = c('year', 'teacher_char')) %>%
  mutate(max = percentage + se,
         min = percentage - se) %>%
  mutate(type = "Private")

```

```{r age_total}
age <- bind_rows(private_age_join, public_age_join)

age_plot <- age %>%
  mutate(year_animate = map_chr(year, ~strsplit(., "-")[[1]][1])) %>%
  mutate(year_animate = as.integer(year_animate)) %>%
  mutate(age_range = factor(teacher_char, 
                               levels = c('Under 30', '30 to 39', '40 to 49',
                                          '50 to 59', '60 and over')))

age_ani_figure <- ggplot(age_plot, aes(x = age_range, y = percentage, color = type)) +
  geom_point(size = 3) + 
  geom_errorbar(aes(x = age_range, ymin = min, ymax = max), 
                width=0.1, color = "gray", alpha=0.9, size=1) +
  transition_time(year_animate) + 
  labs(title = 'Age Ranges of Teachers in U.S. Schools from 1987-2018',
       subtitle = "Year: {frame_time}",
       x = 'Age Ranges',
       y = 'Percentage of Teachers',
       color = 'School Type')

anim_save("age.gif", age_ani_figure)
```

```{r degree_public}
# Percentage values for public schools across all years
public_degree_p <- public %>%
  slice(21:25) %>%
  select(c('teacher_char', `1987-88_p`, `1990-91_p`, `1999-2000_p`, `2003-04_p`,
           `2007-08_p`, `2011-12_p`, `2017-18_p`)) %>%
  rename_with(~tolower(gsub("_p", "", .x))) %>%
  pivot_longer(cols = -teacher_char, names_to = 'year', values_to = 'percentage')

# Percentage standard error values for public schools across all years
public_degree_p_se <- public %>%
  slice(21:25) %>%
  select(c('teacher_char', `1987-88_p_se`, `1990-91_p_se`, `1999-2000_p_se`, 
           `2003-04_p_se`,`2007-08_p_se`, `2011-12_p_se`, `2017-18_p_se`)) %>%
  rename_with(~tolower(gsub("_p_se", "", .x))) %>%
  pivot_longer(cols = -teacher_char, names_to = 'year', values_to = 'se')

# Merged tibble for percentage + standard errors
public_degree_join <- left_join(public_degree_p, 
                             public_degree_p_se, 
                             by = c('year', 'teacher_char')) %>%
  mutate(max = percentage + se,
         min = percentage - se) %>%
  mutate(type = "Public")

ggplot(public_degree_join, aes(x = year, y = percentage, color = teacher_char)) +
  geom_point(size = 2) +
  geom_errorbar(aes(x = year, ymin = min, ymax = max),
                width=0.1, alpha=0.9, size=1) +
  labs(title = 'Highest Degree Earned by U.S. Teachers in Public Schools from 1987-2018',
       x = 'Year',
       y = 'Percentage of Teachers')
```

```{r degree_private}
# Percentage values for public schools across all years
private_degree_p <- private %>%
  slice(21:25) %>%
  select(c('teacher_char', `1987-88_p`, `1990-91_p`, `1999-2000_p`, `2003-04_p`,
           `2007-08_p`, `2011-12_p`, `2017-18_p`)) %>%
  rename_with(~tolower(gsub("_p", "", .x))) %>%
  pivot_longer(cols = -teacher_char, names_to = 'year', values_to = 'percentage')

# Percentage standard error values for public schools across all years
private_degree_p_se <- private %>%
  slice(21:25) %>%
  select(c('teacher_char', `1987-88_p_se`, `1990-91_p_se`, `1999-2000_p_se`, 
           `2003-04_p_se`,`2007-08_p_se`, `2011-12_p_se`, `2017-18_p_se`)) %>%
  rename_with(~tolower(gsub("_p_se", "", .x))) %>%
  pivot_longer(cols = -teacher_char, names_to = 'year', values_to = 'se')

# Merged tibble for percentage + standard errors
private_degree_join <- left_join(private_degree_p, 
                             private_degree_p_se, 
                             by = c('year', 'teacher_char')) %>%
  mutate(max = percentage + se,
         min = percentage - se) %>%
  mutate(type = "Private")

```

```{r years_public}
# Percentage values for public schools across all years
public_years_p <- public %>%
  slice(27:30) %>%
  select(c('teacher_char', `1987-88_p`, `1990-91_p`, `1999-2000_p`, `2003-04_p`,
           `2007-08_p`, `2011-12_p`, `2017-18_p`)) %>%
  rename_with(~tolower(gsub("_p", "", .x))) %>%
  pivot_longer(cols = -teacher_char, names_to = 'year', values_to = 'percentage')

# Percentage standard error values for public schools across all years
public_years_p_se <- public %>%
  slice(27:30) %>%
  select(c('teacher_char', `1987-88_p_se`, `1990-91_p_se`, `1999-2000_p_se`, 
           `2003-04_p_se`,`2007-08_p_se`, `2011-12_p_se`, `2017-18_p_se`)) %>%
  rename_with(~tolower(gsub("_p_se", "", .x))) %>%
  pivot_longer(cols = -teacher_char, names_to = 'year', values_to = 'se')

# Merged tibble for percentage + standard errors
public_years_join <- left_join(public_years_p, 
                             public_years_p_se, 
                             by = c('year', 'teacher_char')) %>%
  mutate(max = percentage + se,
         min = percentage - se) %>%
  mutate(type = "Public")

ggplot(public_years_join, aes(x = year, y = percentage, color = teacher_char)) +
  geom_point(size = 2) +
  geom_errorbar(aes(x = year, ymin = min, ymax = max),
                width=0.1, alpha=0.9, size=1) +
  labs(title = 'Years of Teaching Experience of U.S. Teachers in Public Schools from 1987-2018',
       x = 'Year',
       y = 'Percentage of Teachers')
```
```{r years_private}
# Percentage values for private schools across all years
private_years_p <- private %>%
  slice(27:30) %>%
  select(c('teacher_char', `1987-88_p`, `1990-91_p`, `1999-2000_p`, `2003-04_p`,
           `2007-08_p`, `2011-12_p`, `2017-18_p`)) %>%
  rename_with(~tolower(gsub("_p", "", .x))) %>%
  pivot_longer(cols = -teacher_char, names_to = 'year', values_to = 'percentage')

# Percentage standard error values for private schools across all years
private_years_p_se <- private %>%
  slice(27:30) %>%
  select(c('teacher_char', `1987-88_p_se`, `1990-91_p_se`, `1999-2000_p_se`, 
           `2003-04_p_se`,`2007-08_p_se`, `2011-12_p_se`, `2017-18_p_se`)) %>%
  rename_with(~tolower(gsub("_p_se", "", .x))) %>%
  pivot_longer(cols = -teacher_char, names_to = 'year', values_to = 'se')

# Merged tibble for percentage + standard errors
private_years_join <- left_join(private_years_p, 
                             private_years_p_se, 
                             by = c('year', 'teacher_char')) %>%
  mutate(max = percentage + se,
         min = percentage - se) %>%
  mutate(type = "Private")
```

```{r map_function}
percent_map <- function(var, color, legend.title, min = 0, max = 100) {

  # generate vector of fill colors for map
  shades <- colorRampPalette(c("white", color))(100)
  
  # constrain gradient to percents that occur between min and max
  var <- pmax(var, min)
  var <- pmin(var, max)
  percents <- as.integer(cut(var, 100, 
    include.lowest = TRUE, ordered = TRUE))
  fills <- shades[percents]
  
  # plot choropleth map
  map("state", fill = TRUE, col = fills, resolution = 0,
    lty = 1, lwd = 1, projection = "polyconic", 
    myborder = 0, mar = c(0,0,0,0))
  
  # add a legend
  inc <- (max - min) / 4
  legend.text <- c(paste0("No data"),
    paste0(min + inc, " %"),
    paste0(min + 2 * inc, " %"),
    paste0(min + 3 * inc, " %"),
    paste0(max, " % or more"))
  
  legend("bottomleft", 
    cex = 0.75,
    legend = legend.text, 
    fill = shades[c(1, 25, 50, 75, 100)], 
    title = legend.title)
}
```

```{r import_state}
tabn209_30 <- read_excel("nces_data/tabn209.30.xls", skip = 3,
    col_types = c("text", "skip", "skip", 
        "text", "text", "text", "text", "numeric", 
        "text", "text", "numeric", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "numeric", "text", 
        "text", "numeric", "text", "text", 
        "numeric", "text", "text", "numeric", 
        "text", "text", "numeric", "text"))
  
```
```{r state_degree}
state_degree <- tabn209_30 %>%
  select(c(1, 2, 5, 8, 11)) %>%
  rename(state = `...1`,
         less = `Less than bachelor's`,
         bachelor = `Bachelor's`,
         master = `Master's`,
         eddoc = `Education specialist or doctor's`) %>%
  drop_na(state) %>%
  mutate(state = map_chr(state, ~gsub("\\.", "", .))) %>%
  slice(3:53) %>%
  mutate(less = as.numeric(less),
         bachelor = as.numeric(bachelor),
         master = as.numeric(master),
         eddoc = as.numeric(eddoc)) %>%
  mutate_all(~replace(., is.na(.), 0))
  
percent_map(var = state_degree$less, "darkgreen", "% less")
```
```{r state_years, warning = FALSE}
state_years <- tabn209_30 %>%
  select(c(1, 14, 17, 20, 23)) %>%
  rename(state = `...1`) %>%
  drop_na(state) %>%
  mutate(state = map_chr(state, ~gsub("\\.", "", .))) %>%
  slice(3:53) %>%
  mutate(`Less than 3` = as.numeric(`Less than 3`),
         `3 to 9` = as.numeric(`3 to 9`),
         `10 to 20` = as.numeric(`10 to 20`),
         `Over 20` = as.numeric(`Over 20`)) %>%
  mutate_all(~replace(., is.na(.), 0))
  
percent_map(var = state_years$`Less than 3`, "darkgreen", "% Less than 3 years")
```





